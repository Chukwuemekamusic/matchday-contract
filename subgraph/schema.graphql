# MatchDayBet V2 Subgraph Schema

# Enums
enum MatchStatus {
  OPEN
  CLOSED
  RESOLVED
  CANCELLED
}

enum Outcome {
  NONE
  HOME
  DRAW
  AWAY
}

enum SkipReason {
  NONE
  ALREADY_RESOLVED_SAME_RESULT
  ALREADY_RESOLVED_DIFFERENT_RESULT
  ALREADY_CLOSED
  ALREADY_CANCELLED
  MATCH_NOT_FOUND
  MATCH_IS_RESOLVED
  MATCH_IS_CANCELLED
  KICKOFF_NOT_REACHED
  INVALID_OUTCOME
}

# Core Entities

"""
Represents a football match betting market
"""
type Match @entity(immutable: false) {
  id: ID! # matchId as string
  matchId: BigInt!
  homeTeam: String!
  awayTeam: String!
  competition: String!
  kickoffTime: BigInt!

  # Pools
  totalPool: BigInt!
  homePool: BigInt!
  drawPool: BigInt!
  awayPool: BigInt!

  # Bet counts
  homeBetCount: BigInt!
  drawBetCount: BigInt!
  awayBetCount: BigInt!
  totalBetCount: BigInt!

  # Status
  status: MatchStatus!
  result: Outcome!
  platformFeeAmount: BigInt!

  # Timestamps
  createdAt: BigInt!
  createdAtBlock: BigInt!
  closedAt: BigInt
  resolvedAt: BigInt
  cancelledAt: BigInt

  # Pause state (V2 feature)
  isPaused: Boolean!

  # Financial tracking (V2 feature)
  totalClaimed: BigInt!

  # Relationships
  bets: [Bet!]! @derivedFrom(field: "match")

  # Cancellation reason (if cancelled)
  cancellationReason: String
}

"""
Represents a single bet placed by a user
"""
type Bet @entity(immutable: false) {
  id: ID! # matchId-userAddress
  match: Match!
  bettor: User!
  amount: BigInt!
  prediction: Outcome!
  claimed: Boolean!

  # Calculated when claimed
  payout: BigInt
  profit: BigInt # payout - amount (can be 0 for refunds)

  # Timestamps
  placedAt: BigInt!
  placedAtBlock: BigInt!
  claimedAt: BigInt

  # Transaction reference
  txHash: Bytes!
}

"""
Represents a user (bettor)
"""
type User @entity(immutable: false) {
  id: ID! # User address
  address: Bytes!

  # Betting statistics
  totalBets: BigInt!
  totalWagered: BigInt!
  totalWon: BigInt!
  totalClaimed: BigInt!
  totalProfit: BigInt! # Can be negative

  # Win/loss record
  winCount: BigInt!
  lossCount: BigInt!
  refundCount: BigInt!

  # Relationships
  bets: [Bet!]! @derivedFrom(field: "bettor")

  # Activity timestamps
  firstBetAt: BigInt!
  lastBetAt: BigInt!
  lastActivityAt: BigInt!
}

"""
Global protocol statistics
"""
type GlobalStats @entity(immutable: false) {
  id: ID! # Always "1"

  # Match statistics
  totalMatches: BigInt!
  activeMatches: BigInt!
  resolvedMatches: BigInt!
  cancelledMatches: BigInt!

  # Betting statistics
  totalBets: BigInt!
  totalVolume: BigInt!
  totalFeesCollected: BigInt!
  totalPayouts: BigInt!

  # User statistics
  uniqueBettors: BigInt!

  # V3 Statistics
  currentGracePeriod: BigInt! # Current grace period in seconds
  totalBatchResolutions: BigInt! # Number of batch resolution operations
  totalBatchCancellations: BigInt! # Number of batch cancellation operations
  totalSkippedResolutions: BigInt! # Total matches skipped during resolution
  totalSkippedCancellations: BigInt! # Total matches skipped during cancellation

  # Last updated
  lastUpdatedAt: BigInt!
}

"""
Match managers (bot addresses) - admin tracking
"""
type MatchManager @entity(immutable: false) {
  id: ID! # Manager address
  address: Bytes!
  isActive: Boolean!
  addedAt: BigInt!
  addedAtBlock: BigInt!
  removedAt: BigInt
  removedAtBlock: BigInt
}

"""
Contract upgrade tracking (from UUPS proxy)
"""
type Upgraded @entity(immutable: true) {
  id: Bytes!
  implementation: Bytes! # New implementation address
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

"""
Platform configuration changes
"""
type ConfigUpdate @entity(immutable: true) {
  id: ID! # txHash-logIndex
  type: String! # "STAKE_LIMITS" | "PLATFORM_FEE"

  # Stake limits
  minStake: BigInt
  maxStake: BigInt

  # Platform fee
  platformFeeBps: BigInt

  # Metadata
  blockNumber: BigInt!
  timestamp: BigInt!
  transactionHash: Bytes!
}

# ============ V3 Entities ============

"""
Track individual skipped match resolutions (V3)
"""
type MatchResolutionSkip @entity(immutable: true) {
  id: ID! # txHash-logIndex-matchId
  match: Match!
  skipReason: SkipReason!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
Track batch resolution operations summary (V3)
"""
type BatchResolutionSummary @entity(immutable: true) {
  id: ID! # txHash-logIndex
  matchIds: [BigInt!]!
  results: [Outcome!]!
  resolvedCount: BigInt!
  skippedCount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
Track individual skipped match cancellations (V3)
"""
type MatchCancellationSkip @entity(immutable: true) {
  id: ID! # txHash-logIndex-matchId
  match: Match!
  skipReason: SkipReason!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
Track batch cancellation operations summary (V3)
"""
type BatchCancellationSummary @entity(immutable: true) {
  id: ID! # txHash-logIndex
  matchIds: [BigInt!]!
  reason: String!
  cancelledCount: BigInt!
  skippedCount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
Track grace period configuration changes (V3)
"""
type GracePeriodUpdate @entity(immutable: true) {
  id: ID! # txHash-logIndex
  newGracePeriod: BigInt!
  previousGracePeriod: BigInt
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}
